{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
  <link rel="stylesheet" href="{% static 'styles/style.css' %}" />

  <title>CollabSphere - Room</title>

  <!-- ✅ internal CSS (only for send button + toast) -->
  <style>
    /* Message form: input + send button */
    .message-form {
      display: flex;
      gap: 10px;
      align-items: center;
      width: 100%;
    }

    .message-form input {
      flex: 1;
      width: 100%;
    }

    .btn-send {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      background: #6d28d9; /* purple */
      color: white;
      transition: transform 0.08s ease, opacity 0.2s ease;
      white-space: nowrap;
    }

    .btn-send:active {
      transform: scale(0.98);
      opacity: 0.9;
    }

    /* Toast popup */
    .login-toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%) translateY(10px);
      background: rgba(20, 20, 30, 0.95);
      color: #fff;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 9999;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .login-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  </style>

  <!-- ✅ apply saved theme early to avoid flicker -->
  <script>
    (function () {
      const KEY = "collabsphere-theme";
      const saved = localStorage.getItem(KEY) || "dark";
      document.documentElement.setAttribute("data-theme", saved);
    })();
  </script>
</head>

<body>

  {% include 'navbar.html' %}

  <main class="profile-page layout layout--2">
    <div class="container">

      <!-- Room Start -->
      <div class="room">

        <div class="room__top">
          <div class="room__topLeft">
            <a href="{% url 'home' %}">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
                <title>arrow-left</title>
                <path
                  d="M13.723 2.286l-13.723 13.714 13.719 13.714 1.616-1.611-10.96-10.96h27.625v-2.286h-27.625l10.965-10.965-1.616-1.607z">
                </path>
              </svg>
            </a>
            <h3>Study Room</h3>
          </div>
        </div>

        <div class="room__box scroll">

          <div class="room__header scroll">
            <div class="room__info">
              <h3>{{ room.name }}</h3>
              <span>{{ room.created|timesince }} ago</span>
            </div>

            <div class="room__hosted">
              <p>Hosted By</p>
              <a href="{% url 'user-profile' room.host.id %}" class="room__author">
                <div class="avatar avatar--small">
                  <img src="{{ room.host.avatar.url }}" />
                </div>
                <span>@{{ room.host.username }}</span>
              </a>
            </div>

            <div class="room__details">
              {{ room.description }}
            </div>

            <span class="room__topics">{{ room.topic.name }}</span>
          </div>

          <div class="room__conversation">
            <div class="threads scroll">

              {% for message in room_messages %}
              <div class="thread">
                <div class="thread__top">
                  <div class="thread__author">
                    <a href="{% url 'user-profile' message.user.id %}" class="thread__authorInfo">
                      <div class="avatar avatar--small">
                        <img src="{{ message.user.avatar.url }}" />
                      </div>
                      <span>@{{ message.user.username }}</span>
                    </a>
                    <span class="thread__date">{{ message.created|timesince }} ago</span>
                  </div>

                  {% if request.user == message.user %}
                  <div class="thread__delete">
                    <a href="{% url 'delete-message' message.id %}">
                      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 32 32">
                        <title>remove</title>
                        <path
                          d="M27.314 6.019l-1.333-1.333-9.98 9.981-9.981-9.981-1.333 1.333 9.981 9.981-9.981 9.98 1.333 1.333 9.981-9.98 9.98 9.98 1.333-1.333-9.98-9.98 9.98-9.981z">
                        </path>
                      </svg>
                    </a>
                  </div>
                  {% endif %}
                </div>

                <div class="thread__details">
                  {{ message.body }}
                </div>
              </div>
              {% empty %}
              <p style="padding: 1rem;">No messages yet.</p>
              {% endfor %}

            </div>
          </div>
        </div>

        <!-- ✅ Message input + Send button -->
        <div class="room__message">
          {% if request.user.is_authenticated %}
          <form method="POST" action="" class="message-form">
            {% csrf_token %}
            <input name="body" placeholder="Write your message here..." autocomplete="off" />
            <button type="submit" class="btn-send">Send</button>
          </form>
          {% else %}
          <form id="guest-message-form" class="message-form">
            <input id="guest-message-input" placeholder="Write your message here..." autocomplete="off" />
            <button type="submit" class="btn-send">Send</button>
          </form>
          {% endif %}
        </div>

      </div>
      <!-- Room End -->

      <!-- Participants -->
      <div class="participants">
        <h3 class="participants__top">Participants <span>({{ participants.count }} Joined)</span></h3>
        <div class="participants__list scroll">
          {% for p in participants %}
          <a href="{% url 'user-profile' p.id %}" class="participant">
            <div class="avatar avatar--medium">
              <img src="{{ p.avatar.url }}" />
            </div>
            <p>
              {{ p.name }}
              <span>@{{ p.username }}</span>
            </p>
          </a>
          {% empty %}
          <p style="padding: 1rem;">No participants.</p>
          {% endfor %}
        </div>
      </div>

    </div>
  </main>

  <!-- ✅ Toast -->
  <div id="login-toast" class="login-toast">Login first to send a message</div>

  <!-- ✅ internal JS: guest toast + (optional) theme toggle support if navbar has theme button -->
  <script>
    (function () {
      // ----- Guest submit toast -----
      document.addEventListener("submit", function (e) {
        if (e.target && e.target.id === "guest-message-form") {
          e.preventDefault();

          const toast = document.getElementById("login-toast");
          if (!toast) return;

          toast.classList.add("show");

          const input = document.getElementById("guest-message-input");
          if (input) input.value = "";

          setTimeout(() => toast.classList.remove("show"), 2500);
        }
      });

      // ----- Theme toggle (if your navbar has .theme-toggle) -----
      const THEME_KEY = "collabsphere-theme";
      document.addEventListener("click", function (e) {
        const btn = e.target.closest(".theme-toggle");
        if (!btn) return;

        e.preventDefault();
        const current = document.documentElement.getAttribute("data-theme") || "dark";
        const next = current === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem(THEME_KEY, next);
      });
    })();
    // ----- Dropdown toggle -----
function closeAllDropdowns() {
  document.querySelectorAll(".dropdown-menu.show").forEach((m) => {
    m.classList.remove("show");
  });
}

document.addEventListener("click", function (e) {
  const dropdownBtn = e.target.closest(".dropdown-button");
  if (dropdownBtn) {
    e.preventDefault();
    e.stopPropagation();

    const wrapper = dropdownBtn.closest(".dropdown");
    const menu = wrapper ? wrapper.querySelector(".dropdown-menu") : null;

    if (!menu) {
      console.warn("Dropdown menu not found.");
      return;
    }

    // close other dropdowns
    document.querySelectorAll(".dropdown-menu.show").forEach((m) => {
      if (m !== menu) m.classList.remove("show");
    });

    menu.classList.toggle("show");
    return;
  }

  // click inside menu -> don't close
  if (e.target.closest(".dropdown-menu")) return;

  // outside click -> close
  closeAllDropdowns();
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeAllDropdowns();
});

  </script>


</body>
</html>
